name: Build & Release ESPHome Firmware

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag (e.g. v1.0.0)"
        required: true
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: write
  actions: read
  pages: write

env:
  EXAMPLE_YAML: esphome/dw-ps-01-example.yaml

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure tag exists (workflow_dispatch only)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version }}"
          if [ -z "$VERSION" ]; then
            echo "Missing version input"; exit 1
          fi
          if ! git rev-parse "$VERSION" >/dev/null 2>&1; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git tag -a "$VERSION" -m "Release $VERSION"
            git push origin "$VERSION"
            echo "Created tag $VERSION"
          else
            echo "Tag $VERSION already exists"
          fi

      - name: Set VERSION from event
        id: setver
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi
          echo "repo=${GITHUB_REPOSITORY}" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install ESPHome
        run: |
          python -m pip install --upgrade pip
          pip install esphome

      - name: Show ESPHome version
        run: esphome version

      - name: Compile firmware
        run: |
          esphome compile "${EXAMPLE_YAML}"

      - name: Locate build artifacts
        id: locate
        run: |
          set -euo pipefail
          # Find first match of each artifact anywhere under .esphome/build
          FACTORY="$(find .esphome/build -type f -name 'firmware-factory.bin' | head -n 1 || true)"
          OTA="$(find .esphome/build -type f -name 'firmware.bin' | head -n 1 || true)"

          if [ -z "${FACTORY}" ] || [ ! -f "${FACTORY}" ]; then
            echo "Factory binary not found"; find .esphome/build -maxdepth 3 -type f -name 'firmware*' -ls; exit 1
          fi
          if [ -z "${OTA}" ] || [ ! -f "${OTA}" ]; then
            echo "OTA binary not found"; find .esphome/build -maxdepth 3 -type f -name 'firmware*' -ls; exit 1
          fi

          mkdir -p dist
          OUT_FACTORY="dist/dw-ps-01.factory-${{ steps.setver.outputs.version }}.bin"
          OUT_OTA="dist/dw-ps-01-ota-${{ steps.setver.outputs.version }}.bin"
          cp "${FACTORY}" "${OUT_FACTORY}"
          cp "${OTA}" "${OUT_OTA}"

          echo "factory=${OUT_FACTORY}" >> "$GITHUB_OUTPUT"
          echo "ota=${OUT_OTA}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.setver.outputs.version }}
          name: ${{ steps.setver.outputs.version }}
          draft: false
          prerelease: false
          files: |
            ${{ steps.locate.outputs.factory }}
            ${{ steps.locate.outputs.ota }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- Pages / manifest auto-bump ---
      - name: Ensure docs directory & base manifest
        run: |
          set -euo pipefail
          mkdir -p docs
          if [ ! -f docs/manifest.json ]; then
            cat > docs/manifest.json <<'JSON'
{
  "name": "DW Presence Sensor",
  "version": "v0.0.0",
  "builds": [
    {
      "chipFamily": "ESP32-S3",
      "parts": [
        {
          "path": "",
          "offset": 0
        }
      ]
    }
  ]
}
JSON
          fi

      - name: Update docs/manifest.json to latest tag
        env:
          VERSION: ${{ steps.setver.outputs.version }}
          REPO: ${{ steps.setver.outputs.repo }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq
          URL="https://github.com/${REPO}/releases/download/${VERSION}/dw-ps-01.factory-${VERSION}.bin"
          TMP="$(mktemp)"
          jq --arg ver "$VERSION" --arg url "$URL" \
             '.version=$ver | .builds[0].parts[0].path=$url' \
             docs/manifest.json > "$TMP"
          mv "$TMP" docs/manifest.json

      - name: Commit updated manifest
        run: |
          set -euo pipefail
          if git diff --quiet docs/manifest.json; then
            echo "No manifest changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/manifest.json
          git commit -m "chore(docs): bump manifest to ${{ steps.setver.outputs.version }}"
          git push

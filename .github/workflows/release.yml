name: Build & Release ESPHome Firmware

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag (e.g. v1.0.0)"
        required: true
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  EXAMPLE_YAML: esphome/dw-ps-01-example.yaml

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version and repo outputs
        id: setver
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi
          echo "repo=${GITHUB_REPOSITORY}" >> "$GITHUB_OUTPUT"

      - name: Ensure tag exists (manual runs)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          VERSION="${{ steps.setver.outputs.version }}"
          if ! git rev-parse "$VERSION" >/dev/null 2>&1; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git tag -a "$VERSION" -m "Release $VERSION"
            git push origin "$VERSION"
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ESPHome
        run: |
          python -m pip install --upgrade pip
          pip install esphome

      - name: Show ESPHome version
        run: esphome version

      - name: Compile firmware
        run: esphome compile "${EXAMPLE_YAML}"

      - name: Find build artifacts
        id: find
        run: |
          FACTORY="$(find .esphome/build -type f -name 'firmware-factory.bin' | head -n 1)"
          OTA="$(find .esphome/build -type f -name 'firmware.bin' | head -n 1)"
          if [ -z "$FACTORY" ] || [ ! -f "$FACTORY" ]; then
            echo "Factory binary not found"
            find .esphome/build -maxdepth 5 -type f -name 'firmware*' -ls
            exit 1
          fi
          if [ -z "$OTA" ] || [ ! -f "$OTA" ]; then
            echo "OTA binary not found"
            find .esphome/build -maxdepth 5 -type f -name 'firmware*' -ls
            exit 1
          fi
          mkdir -p dist
          OUT_FACTORY="dist/dw-ps-01.factory-${{ steps.setver.outputs.version }}.bin"
          OUT_OTA="dist/dw-ps-01-ota-${{ steps.setver.outputs.version }}.bin"
          cp "$FACTORY" "$OUT_FACTORY"
          cp "$OTA" "$OUT_OTA"
          echo "factory=$OUT_FACTORY" >> "$GITHUB_OUTPUT"
          echo "ota=$OUT_OTA" >> "$GITHUB_OUTPUT"

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.setver.outputs.version }}
          name: ${{ steps.setver.outputs.version }}
          files: |
            ${{ steps.find.outputs.factory }}
            ${{ steps.find.outputs.ota }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure docs/manifest.json exists
        run: |
          mkdir -p docs
          if [ ! -f docs/manifest.json ]; then
            echo '{"name":"DW Presence Sensor","version":"v0.0.0","builds":[{"chipFamily":"ESP32-S3","parts":[{"path":"","offset":0}]}]}' > docs/manifest.json
          fi

      - name: Update manifest to latest release
        run: |
          VERSION="${{ steps.setver.outputs.version }}"
          REPO="${{ steps.setver.outputs.repo }}"
          URL="https://github.com/${REPO}/releases/download/${VERSION}/dw-ps-01.factory-${VERSION}.bin"
          python - <<PY
import json, os
p = "docs/manifest.json"
with open(p, "r", encoding="utf-8") as f:
    data = json.load(f)
if "builds" not in data or not data["builds"]:
    data["builds"] = [{"chipFamily": "ESP32-S3", "parts": [{"path": "", "offset": 0}]}]
data["version"] = os.environ["VERSION"]
data["builds"][0]["parts"][0]["path"] = os.environ["URL"]
with open(p, "w", encoding="utf-8") as f:
    json.dump(data, f, indent=2)
print("Updated", p)
PY
        env:
          VERSION: ${{ steps.setver.outputs.version }}
          URL: https://github.com/${{ steps.setver.outputs.repo }}/releases/download/${{ steps.setver.outputs.version }}/dw-ps-01.factory-${{ steps.setver.outputs.version }}.bin

      - name: Commit manifest if changed
        run: |
          if git diff --quiet docs/manifest.json; then
            echo "No manifest changes"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/manifest.json
          git commit -m "docs: bump manifest to ${{ steps.setver.outputs.version }}"
          git push

name: Build & Release ESPHome Firmware

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag (e.g. v1.0.0)"
        required: true
        type: string
  push:
    tags: ["v*"]

permissions:
  contents: write

env:
  EXAMPLE_YAML: esphome/dw-ps-01-example.yaml

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set VERSION
        id: ver
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi
          echo "repo=${GITHUB_REPOSITORY}" >> $GITHUB_OUTPUT

      - name: Ensure tag exists (manual runs)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          V="${{ steps.ver.outputs.version }}"
          git rev-parse "$V" >/dev/null 2>&1 || {
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git tag -a "$V" -m "Release $V"
            git push origin "$V"
          }

      - name: Setup Python
        uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install ESPHome
        run: |
          python -m pip install --upgrade pip
          pip install esphome

      - name: Compile
        run: esphome compile "${EXAMPLE_YAML}"

      - name: Find artifacts
        id: find
        run: |
          FACTORY="$(find .esphome/build -name 'firmware-factory.bin' -type f | head -n1)"
          OTA="$(find .esphome/build -name 'firmware.bin' -type f | head -n1)"
          [ -f "$FACTORY" ] || { echo "No factory bin"; exit 1; }
          [ -f "$OTA" ] || { echo "No OTA bin"; exit 1; }
          mkdir -p dist
          OUTF="dist/dw-ps-01.factory-${{ steps.ver.outputs.version }}.bin"
          OUTO="dist/dw-ps-01-ota-${{ steps.ver.outputs.version }}.bin"
          cp "$FACTORY" "$OUTF"
          cp "$OTA" "$OUTO"
          echo "factory=$OUTF" >> $GITHUB_OUTPUT
          echo "ota=$OUTO" >> $GITHUB_OUTPUT

      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.version }}
          name: ${{ steps.ver.outputs.version }}
          files: |
            ${{ steps.find.outputs.factory }}
            ${{ steps.find.outputs.ota }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure docs/manifest.json
        run: |
          mkdir -p docs
          if [ ! -f docs/manifest.json ]; then
            printf '%s\n' \
            '{' \
            '  "name": "DW Presence Sensor",' \
            '  "version": "v0.0.0",' \
            '  "builds": [{' \
            '    "chipFamily": "ESP32-S3",' \
            '    "parts": [{"path": "", "offset": 0}]' \
            '  }]' \
            '}' > docs/manifest.json
          fi

      - name: Update manifest to latest
        run: |
          VERSION='${{ steps.ver.outputs.version }}'
          REPO='${{ steps.ver.outputs.repo }}'
          URL="https://github.com/${REPO}/releases/download/${VERSION}/dw-ps-01.factory-${VERSION}.bin"
          # Minimal jq-free update to avoid YAML quoting issues
          python - <<'PY'
import json,sys,os
p="docs/manifest.json"
with open(p) as f: d=json.load(f)
d.setdefault("builds",[{"chipFamily":"ESP32-S3","parts":[{"path":"","offset":0}]}])
d["version"]=os.environ["VERSION"]
d["builds"][0]["parts"][0]["path"]=os.environ["URL"]
with open(p,"w") as f: json.dump(d,f,indent=2)
print("updated",p)
PY
        env:
          VERSION: ${{ steps.ver.outputs.version }}
          URL: https://github.com/${{ steps.ver.outputs.repo }}/releases/download/${{ steps.ver.outputs.version }}/dw-ps-01.factory-${{ steps.ver.outputs.version }}.bin

      - name: Commit manifest
        run: |
          if git diff --quiet docs/manifest.json; then
            echo "No changes"; exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/manifest.json
          git commit -m "docs: bump manifest to ${{ steps.ver.outputs.version }}"
          git push
